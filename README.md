# Alnitak Flutter - è§†é¢‘æ’­æ”¾åº”ç”¨

ä¸€ä¸ªåŸºäº Flutter å¼€å‘çš„è§†é¢‘æ’­æ”¾åº”ç”¨,æ”¯æŒ HLS æµåª’ä½“æ’­æ”¾ã€æ¸…æ™°åº¦åˆ‡æ¢ã€å…¨å±æ’­æ”¾ç­‰åŠŸèƒ½ã€‚

## ğŸ“± é¡¹ç›®æ¦‚è¿°

- **é¡¹ç›®åç§°**: Alnitak Flutter
- **ç‰ˆæœ¬**: 1.0.0+1
- **Flutter SDK**: 3.9.2
- **å¼€å‘è¯­è¨€**: Dart
- **æ€»ä»£ç è¡Œæ•°**: çº¦ 4,353 è¡Œ

## âœ¨ æ ¸å¿ƒåŠŸèƒ½
## åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°
- ğŸ  åŒåˆ—å¸ƒå±€é¦–é¡µï¼ˆå‚è€ƒå“”å“©å“”å“©å›½é™…ç‰ˆï¼‰
- ğŸ“± åº•éƒ¨å¯¼èˆªæ ï¼ˆé¦–é¡µã€æˆ‘çš„ï¼‰
- ğŸ¬ çƒ­é—¨è§†é¢‘åˆ—è¡¨å±•ç¤º
- ğŸ“„ åˆ†é¡µåŠ è½½ï¼ˆæ»šåŠ¨åˆ°åº•éƒ¨è‡ªåŠ¨åŠ è½½æ›´å¤šï¼‰
- ğŸ–¼ï¸ è§†é¢‘å¡ç‰‡å±•ç¤ºï¼ˆå°é¢ã€æ ‡é¢˜ã€ä½œè€…ã€æ’­æ”¾æ•°ã€æ—¶é•¿ç­‰ï¼‰
- ğŸŒ API å¯¹æ¥ï¼ˆçƒ­é—¨è§†é¢‘æ¥å£ï¼‰
- ğŸ¥ **è§†é¢‘æ’­æ”¾é¡µé¢**
  - è§†é¢‘æ’­æ”¾å™¨
  - ä½œè€…ä¿¡æ¯å¡ç‰‡ï¼ˆå¤´åƒã€åå­—ã€ç²‰ä¸æ•°ã€å…³æ³¨æŒ‰é’®ï¼‰
  - è§†é¢‘ä¿¡æ¯å±•ç¤ºï¼ˆæ ‡é¢˜ã€æ’­æ”¾é‡ã€å¼¹å¹•æ•°ã€ä¸Šä¼ æ—¶é—´ã€åœ¨çº¿äººæ•°ï¼‰
  - ä¸‰å¤§æ“ä½œæŒ‰é’®ï¼ˆç‚¹èµã€æ”¶è—ã€åˆ†äº«ï¼‰
  - åˆ†é›†åˆ—è¡¨æ”¯æŒï¼ˆåˆ—è¡¨/ç½‘æ ¼è§†å›¾åˆ‡æ¢ã€è‡ªåŠ¨è¿æ’­ï¼‰
  - è§†é¢‘æ¨èåŒºåŸŸï¼ˆç›¸å…³æ¨èã€è‡ªåŠ¨è¿æ’­æš‚ä¸å¯ç”¨ï¼‰
  - æ’­æ”¾è¿›åº¦è®°å¿†ä¸ä¸ŠæŠ¥ï¼ˆç­‰ç™»å½•å’Œæ³¨å†Œå¼€å‘æ‰èƒ½ç”Ÿæ•ˆï¼‰
  - å“åº”å¼å¸ƒå±€ï¼ˆå®½å±å·¦å³ä¸¤æ ï¼Œçª„å±å•æ ï¼‰

### ğŸš§ å¼€å‘ä¸­
- è¯„è®ºåŠŸèƒ½
- å¼¹å¹•åŠŸèƒ½
- ç”¨æˆ·ç™»å½•/æ³¨å†Œ
- æœç´¢åŠŸèƒ½

## é¡¹ç›®ç»“æ„



### ğŸ¬ è§†é¢‘æ’­æ”¾
- âœ… HLS (M3U8) æµåª’ä½“æ’­æ”¾
- âœ… å¤šæ¸…æ™°åº¦åˆ‡æ¢(360P/480P/720P/1080P/4K ç­‰)
- âœ… å‹å¥½çš„æ¸…æ™°åº¦åç§°æ˜¾ç¤º
- âœ… æ’­æ”¾è¿›åº¦ä¿å­˜å’Œæ¢å¤
- âœ… æ’­æ”¾å†å²è®°å½•åŒæ­¥

### ğŸ“º æ’­æ”¾å™¨åŠŸèƒ½
- âœ… å…¨å±/éå…¨å±æ¨¡å¼åˆ‡æ¢
- âœ… æ¨ªç«–å±è‡ªåŠ¨é€‚é…
- âœ… æ‰‹åŠ¿æ§åˆ¶(äº®åº¦ã€éŸ³é‡ã€è¿›åº¦)
- âœ… åŒå‡»æš‚åœ/æ’­æ”¾
- âœ… æ’­æ”¾é€Ÿåº¦è°ƒèŠ‚
- âœ… ç”»è´¨è‡ªé€‚åº”

### ğŸ¨ ç•Œé¢ç‰¹æ€§
- âœ… Material Design 3 è®¾è®¡
- âœ… è‡ªå®šä¹‰æ’­æ”¾å™¨æ§åˆ¶æ 
- âœ… è§†é¢‘ä¿¡æ¯å¡ç‰‡å±•ç¤º
- âœ… ä½œè€…ä¿¡æ¯å±•ç¤º
- âœ… åˆ†Pé€‰é›†åˆ—è¡¨
- âœ… æ¨èè§†é¢‘åˆ—è¡¨
- âœ… è§†é¢‘æ“ä½œæŒ‰é’®(ç‚¹èµã€æ”¶è—ã€åˆ†äº«ç­‰)

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒæŠ€æœ¯æ ˆ
- **UI æ¡†æ¶**: Flutter 3.35.7
- **è§†é¢‘æ’­æ”¾**: media_kit (åŸºäº AndroidX Media3)
  - `media_kit`: ^1.1.10 - æ ¸å¿ƒæ’­æ”¾å™¨
  - `media_kit_video`: ^1.2.4 - è§†é¢‘ UI ç»„ä»¶
  - `media_kit_libs_video`: ^1.0.4 - åŸç”Ÿ libmpv åº“
- **ç½‘ç»œè¯·æ±‚**: 
  - `http`: ^1.2.0 - HTTP å®¢æˆ·ç«¯
  - `dio`: ^5.4.0 - é«˜çº§ç½‘ç»œåº“
- **æœ¬åœ°å­˜å‚¨**: 
  - `shared_preferences`: ^2.2.0 - è½»é‡çº§é”®å€¼å­˜å‚¨
  - `path_provider`: ^2.1.1 - è·¯å¾„è·å–
- **åˆ†äº«åŠŸèƒ½**: `share_plus`: ^7.2.0
- **å›½é™…åŒ–**: `intl`: ^0.18.1

### é¡¹ç›®ç»“æ„
```
lib/
â”œâ”€â”€ main.dart                      # åº”ç”¨å…¥å£
â”œâ”€â”€ models/                        # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ api_response.dart         # API å“åº”å°è£…
â”‚   â”œâ”€â”€ video_api_model.dart      # è§†é¢‘ API æ¨¡å‹
â”‚   â”œâ”€â”€ video_detail.dart         # è§†é¢‘è¯¦æƒ…æ¨¡å‹
â”‚   â””â”€â”€ video_item.dart           # è§†é¢‘åˆ—è¡¨é¡¹æ¨¡å‹
â”œâ”€â”€ pages/                         # é¡µé¢
â”‚   â”œâ”€â”€ main_page.dart            # ä¸»é¡µé¢(åº•éƒ¨å¯¼èˆª)
â”‚   â”œâ”€â”€ home_page.dart            # é¦–é¡µ(è§†é¢‘åˆ—è¡¨)
â”‚   â”œâ”€â”€ profile_page.dart         # ä¸ªäººä¸­å¿ƒ
â”‚   â””â”€â”€ video/                    # è§†é¢‘æ’­æ”¾ç›¸å…³
â”‚       â”œâ”€â”€ video_play_page.dart  # è§†é¢‘æ’­æ”¾é¡µé¢
â”‚       â””â”€â”€ widgets/              # è§†é¢‘é¡µé¢ç»„ä»¶
â”‚           â”œâ”€â”€ media_player_widget.dart    # è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶(706è¡Œ)
â”‚           â”œâ”€â”€ author_card.dart           # ä½œè€…ä¿¡æ¯å¡ç‰‡
â”‚           â”œâ”€â”€ part_list.dart             # åˆ†Påˆ—è¡¨
â”‚           â”œâ”€â”€ recommend_list.dart        # æ¨èåˆ—è¡¨
â”‚           â”œâ”€â”€ video_action_buttons.dart  # è§†é¢‘æ“ä½œæŒ‰é’®
â”‚           â””â”€â”€ video_info_card.dart       # è§†é¢‘ä¿¡æ¯å¡ç‰‡
â”œâ”€â”€ services/                      # ä¸šåŠ¡æœåŠ¡
â”‚   â”œâ”€â”€ hls_service.dart          # HLS æµå¤„ç†æœåŠ¡
â”‚   â”œâ”€â”€ logger_service.dart       # æ—¥å¿—æœåŠ¡
â”‚   â”œâ”€â”€ video_api_service.dart    # è§†é¢‘ API æœåŠ¡
â”‚   â””â”€â”€ video_service.dart        # è§†é¢‘ä¸šåŠ¡æœåŠ¡
â”œâ”€â”€ utils/                         # å·¥å…·ç±»
â”‚   â”œâ”€â”€ http_client.dart          # HTTP å®¢æˆ·ç«¯å°è£…
â”‚   â””â”€â”€ image_utils.dart          # å›¾ç‰‡å·¥å…·ç±»
â””â”€â”€ widgets/                       # é€šç”¨ç»„ä»¶
    â””â”€â”€ video_card.dart           # è§†é¢‘å¡ç‰‡ç»„ä»¶
```

## ğŸ¯ æ ¸å¿ƒç»„ä»¶è¯´æ˜

### MediaPlayerWidget (è§†é¢‘æ’­æ”¾å™¨)
ä½ç½®: `lib/pages/video/widgets/media_player_widget.dart`

æ ¸å¿ƒåŠŸèƒ½:
- **HLS æµå¤„ç†**: è‡ªåŠ¨ä¸‹è½½å¹¶è§£æ M3U8 æ–‡ä»¶,è½¬æ¢ä¸ºæœ¬åœ°å¯è®¿é—®çš„æ’­æ”¾åœ°å€
- **æ¸…æ™°åº¦åˆ‡æ¢**: æ”¯æŒå¤šç§æ¸…æ™°åº¦æ— ç¼åˆ‡æ¢,ä¿æŒæ’­æ”¾è¿›åº¦
- **å…¨å±ç®¡ç†**: è‡ªåŠ¨å¤„ç†æ¨ªç«–å±åˆ‡æ¢å’Œç³»ç»Ÿ UI æ˜¾ç¤º/éšè—
- **æ’­æ”¾çŠ¶æ€ç®¡ç†**: å®Œæ•´çš„æ’­æ”¾å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†(åˆå§‹åŒ–ã€æ’­æ”¾ã€æš‚åœã€é”€æ¯)
- **è¿›åº¦åŒæ­¥**: å®šæœŸå‘æœåŠ¡å™¨åŒæ­¥æ’­æ”¾è¿›åº¦

å…³é”®é…ç½®:
```dart
MaterialVideoControlsTheme(
  seekBarMargin: EdgeInsets.only(bottom: 44),        // è¿›åº¦æ¡ä½ç½®
  bottomButtonBarMargin: EdgeInsets.only(bottom: 0), // æ§åˆ¶æŒ‰é’®ä½ç½®
  displaySeekBar: true,                              // æ˜¾ç¤ºè¿›åº¦æ¡
  automaticallyImplySkipNextButton: false,           // éšè—ä¸‹ä¸€é›†æŒ‰é’®
  automaticallyImplySkipPreviousButton: false,       // éšè—ä¸Šä¸€é›†æŒ‰é’®
)
```

### HlsService (HLS æµå¤„ç†)
ä½ç½®: `lib/services/hls_service.dart`

åŠŸèƒ½:
- ä¸‹è½½ M3U8 æ–‡ä»¶å¹¶è§£æ
- è½¬æ¢ç›¸å¯¹è·¯å¾„ä¸ºç»å¯¹ URL
- ç¼“å­˜å¤„ç†çš„ M3U8 æ–‡ä»¶åˆ°æœ¬åœ°
- æä¾›æœ¬åœ°æ–‡ä»¶è·¯å¾„ä¾›æ’­æ”¾å™¨ä½¿ç”¨

### VideoService (è§†é¢‘ä¸šåŠ¡æœåŠ¡)
ä½ç½®: `lib/services/video_service.dart`

åŠŸèƒ½:
- è·å–è§†é¢‘è¯¦æƒ…ä¿¡æ¯
- è·å–è§†é¢‘èµ„æºå’Œæ¸…æ™°åº¦åˆ—è¡¨ï¼ˆæŒ‡çš„æ˜¯æ’­æ”¾å™¨ï¼‰
- æ’­æ”¾è¿›åº¦ç®¡ç†ï¼ˆæŒ‡çš„æ˜¯æ’­æ”¾å™¨ï¼‰
- å†å²è®°å½•ç®¡ç†ï¼ˆæŒ‡çš„æ˜¯æ’­æ”¾å™¨ï¼‰

## ğŸ› ï¸ æ„å»ºè¯´æ˜

### ç¯å¢ƒè¦æ±‚
- Flutter SDK: 3.35.7
- Dart SDK: 3.9.2
- Android: 
  - minSdk: 21
  - targetSdk: 34
  - Java: 11+
  - Kotlin: 1.9.0+

### ç¼–è¯‘å‘½ä»¤

#### Debug ç‰ˆæœ¬
```bash
flutter run -d <device_id>
```

#### Release ç‰ˆæœ¬ (æ¨è - åˆ†æ¶æ„ç¼–è¯‘)
```bash
flutter build apk --release --split-per-abi
```

ç”Ÿæˆçš„ APK æ–‡ä»¶:
- `app-armeabi-v7a-release.apk` (25.7MB) - 32ä½ ARM è®¾å¤‡
- `app-arm64-v8a-release.apk` (28.9MB) - 64ä½ ARM è®¾å¤‡(æ¨è)
- `app-x86_64-release.apk` (33.3MB) - x86_64 è®¾å¤‡/æ¨¡æ‹Ÿå™¨

#### Release ç‰ˆæœ¬ (é€šç”¨åŒ…)
```bash
flutter build apk --release
```

### é‡è¦é…ç½®è¯´æ˜

#### Gradle é…ç½® (`android/gradle.properties`)
```properties
# ç¦ç”¨ Kotlin å¢é‡ç¼–è¯‘(è§£å†³è·¨ç›˜ç¬¦è·¯å¾„é—®é¢˜)
kotlin.incremental=false
kotlin.incremental.java=false
kotlin.caching.enabled=false
org.gradle.caching=false

# JVM å†…å­˜é…ç½®
org.gradle.jvmargs=-Xmx4G -XX:MaxMetaspaceSize=1G -XX:+HeapDumpOnOutOfMemoryError

# AndroidX æ”¯æŒ
android.useAndroidX=true
android.enableJetifier=true
```

> âš ï¸ **æ³¨æ„**: å¦‚æœé¡¹ç›®å’Œ Flutter SDK/Pub Cache åœ¨ä¸åŒç›˜ç¬¦,å¿…é¡»ç¦ç”¨ Kotlin å¢é‡ç¼–è¯‘,å¦åˆ™ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯ã€‚

## ğŸ“¡ API æ¥å£

åç«¯ API åœ°å€: `http://anime.ayypd.cn:3000`

ä¸»è¦æ¥å£:
- `GET /api/v1/video/getHotVideo` - è·å–çƒ­é—¨è§†é¢‘åˆ—è¡¨
- `GET /api/v1/video/getVideoById` - è·å–è§†é¢‘è¯¦æƒ…
- `GET /api/v1/video/getResourceQuality` - è·å–è§†é¢‘æ¸…æ™°åº¦åˆ—è¡¨
- `GET /api/v1/video/getVideoFile` - è·å–è§†é¢‘æ’­æ”¾åœ°å€
- `GET /api/v1/video/getRelatedVideoList` - è·å–ç›¸å…³æ¨è
- `POST /api/v1/history/video/addHistory` - æ·»åŠ æ’­æ”¾å†å²
- `GET /api/v1/history/video/getProgress` - è·å–æ’­æ”¾è¿›åº¦

## ğŸ› å·²çŸ¥é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 1. Kotlin ç¼–è¯‘é”™è¯¯
**é—®é¢˜**: è·¨ç›˜ç¬¦(C: å’Œ E:)ç¼–è¯‘æ—¶å‡ºç° `IllegalArgumentException: this and base files have different roots`

**è§£å†³æ–¹æ¡ˆ**: åœ¨ `android/gradle.properties` ä¸­ç¦ç”¨ Kotlin å¢é‡ç¼–è¯‘

### 2. libmpv.so æ‰¾ä¸åˆ°
**é—®é¢˜**: è¿è¡Œæ—¶æŠ¥é”™ `Cannot find libmpv.so`

**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿ `media_kit_libs_video` ä¾èµ–å·²æ­£ç¡®æ·»åŠ åˆ° `pubspec.yaml`

### 3. å…¨å±æ’­æ”¾é»‘å±
**é—®é¢˜**: åˆ‡æ¢å…¨å±åç”»é¢ä¸æ˜¾ç¤º

**è§£å†³æ–¹æ¡ˆ**: å·²é€šè¿‡æ­£ç¡®é…ç½® `SystemChrome` å’Œ Widget ç”Ÿå‘½å‘¨æœŸç®¡ç†è§£å†³

## ğŸ“¦ ä¾èµ–è¯´æ˜

### æ ¸å¿ƒä¾èµ–
- **media_kit**: AndroidX Media3 çš„ Flutter å°è£…,æä¾›å¼ºå¤§çš„è§†é¢‘æ’­æ”¾èƒ½åŠ›
  - æ”¯æŒ HLSã€MP4ã€WebM ç­‰å¤šç§æ ¼å¼
  - å†…ç½®ç¼“å†²ç®¡ç†å’Œè‡ªé€‚åº”ç ç‡
  - åŸç”Ÿæ€§èƒ½ä¼˜åŒ–

### æ¸…ç†çš„æ—§ä¾èµ–
ä»¥ä¸‹æ–‡ä»¶å·²ä»é¡¹ç›®ä¸­ç§»é™¤(ä½¿ç”¨ media_kit åŸç”Ÿæ§ä»¶æ›¿ä»£):
- âŒ `player_controller_state.dart` - æ—§æ’­æ”¾å™¨çŠ¶æ€ç®¡ç†
- âŒ `player_gesture_detector.dart` - æ—§æ‰‹åŠ¿æ£€æµ‹
- âŒ `player_top_bar.dart` - æ—§é¡¶éƒ¨æ§åˆ¶æ 
- âŒ `player_bottom_bar.dart` - æ—§åº•éƒ¨æ§åˆ¶æ 
- âŒ `media_progress_slider.dart` - æ—§è¿›åº¦æ¡

## ğŸš€ å¼€å‘æŒ‡å—

### è°ƒè¯•æ—¥å¿—
é¡¹ç›®ä½¿ç”¨ `logger_service.dart` æä¾›ç»Ÿä¸€çš„æ—¥å¿—è¾“å‡º:
```dart
LoggerService.debug('æ—¥å¿—æ¶ˆæ¯');
LoggerService.error('é”™è¯¯æ¶ˆæ¯', error: e, stackTrace: st);
```

æ—¥å¿—è¾“å‡ºæ ¼å¼:
- ğŸ” DEBUG - è°ƒè¯•ä¿¡æ¯
- âš ï¸ WARNING - è­¦å‘Šä¿¡æ¯
- âŒ ERROR - é”™è¯¯ä¿¡æ¯
- ğŸ“¹ - è§†é¢‘æ’­æ”¾ç›¸å…³æ—¥å¿—

### æ·»åŠ æ–°è§†é¢‘æº
1. åœ¨ `VideoService` ä¸­æ·»åŠ æ–°çš„ API è°ƒç”¨
2. æ›´æ–° `VideoDetailModel` ä»¥æ”¯æŒæ–°å­—æ®µ
3. ä¿®æ”¹ `HlsService` ä»¥å¤„ç†ä¸åŒçš„æµæ ¼å¼(å¦‚éœ€è¦)
4. æ›´æ–° UI ç»„ä»¶ä»¥å±•ç¤ºæ–°æ•°æ®

### è‡ªå®šä¹‰æ’­æ”¾å™¨æ ·å¼
ä¿®æ”¹ `media_player_widget.dart` ä¸­çš„ `MaterialVideoControlsTheme`:
```dart
MaterialVideoControlsTheme(
  seekBarMargin: EdgeInsets.only(bottom: 44),  // è°ƒæ•´è¿›åº¦æ¡ä½ç½®
  bottomButtonBarMargin: EdgeInsets.only(bottom: 0),  // è°ƒæ•´æŒ‰é’®ä½ç½®
  seekBarColor: Colors.blue,  // è¿›åº¦æ¡é¢œè‰²
  // ... æ›´å¤šé…ç½®é¡¹
)
```

## ğŸ“ ç‰ˆæœ¬å†å²

### v1.0.0 (2025-01-04)
- âœ… åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ… å®ç°åŸºç¡€è§†é¢‘æ’­æ”¾åŠŸèƒ½
- âœ… æ”¯æŒ HLS æµåª’ä½“æ’­æ”¾
- âœ… æ¸…æ™°åº¦åˆ‡æ¢åŠŸèƒ½
- âœ… å…¨å±æ’­æ”¾æ”¯æŒ
- âœ… æ’­æ”¾å†å²å’Œè¿›åº¦åŒæ­¥
- âœ… è§£å†³ Kotlin ç¼–è¯‘è·¨ç›˜ç¬¦é—®é¢˜
- âœ… ä¼˜åŒ–æ’­æ”¾å™¨æ§ä»¶ä½ç½®

## ğŸ”— ç›¸å…³é“¾æ¥

- [Flutter å®˜æ–¹æ–‡æ¡£](https://flutter.dev/docs)
- [media_kit GitHub](https://github.com/alexmercerind/media_kit)
- [Material Design 3](https://m3.material.io/)

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ã€‚

## ğŸ‘¥ è´¡çŒ®è€…

- å¼€å‘è€…: æ‚¨çš„åå­—
- æŠ€æœ¯æ”¯æŒ: Claude AI

---

**æœ€åæ›´æ–°**: 2025-01-04
