# Alnitak Flutter 开发进度文档

## 项目概述

本项目是一个类似哔哩哔哩国际版的 Flutter 移动应用，主要功能包括视频浏览、双列布局展示等。

## 开发环境

- **Flutter SDK**: ^3.9.2
- **开发平台**: Android / iOS
- **后端API**: `http://anime.ayypd.cn:3000`

---

## 已完成功能 ✅

### 1. 基础架构搭建 (2024-XX-XX)

#### 1.1 项目初始化
- [x] Flutter 项目创建和配置
- [x] 解决 NDK 构建问题（删除损坏的 NDK 目录）
- [x] Android 网络权限配置
- [x] HTTP 明文流量支持配置（`usesCleartextTraffic`）

#### 1.2 项目结构
```
lib/
├── main.dart                 # 应用入口
├── models/                   # 数据模型
│   ├── api_response.dart
│   ├── video_api_model.dart
│   └── video_item.dart
├── pages/                    # 页面组件
│   ├── home_page.dart
│   ├── main_page.dart
│   └── profile_page.dart
├── services/                 # 服务层
│   └── video_api_service.dart
└── widgets/                  # UI组件
    └── video_card.dart
```

---

### 2. UI 界面开发 (2024-XX-XX)

#### 2.1 底部导航栏
- [x] 创建主页面 (`MainPage`) 包含底部导航栏
- [x] 实现两个标签页：**首页** 和 **我的**
- [x] 使用 `IndexedStack` 保持页面状态

**文件**: `lib/pages/main_page.dart`

#### 2.2 首页界面
- [x] 双列网格布局（参考哔哩哔哩国际版）
- [x] 视频卡片组件设计
- [x] 封面图片展示（16:9 比例）
- [x] 视频信息展示：
  - 视频标题（最多2行，超出省略）
  - 作者用户名和头像
  - 播放次数（格式化：1.2万、3.4k）
  - 视频时长（mm:ss 格式）
  - 弹幕数量（格式化显示）

**文件**: 
- `lib/pages/home_page.dart`
- `lib/widgets/video_card.dart`

#### 2.3 我的页面
- [x] 用户信息头部展示
- [x] 功能菜单列表
- [x] 基础布局和样式

**文件**: `lib/pages/profile_page.dart`

---

### 3. API 对接开发 (2024-XX-XX)

#### 3.1 数据模型
- [x] API 响应模型 (`ApiResponse`, `VideoData`)
- [x] 视频API模型 (`VideoApiModel`)
- [x] 作者模型 (`AuthorModel`)
- [x] 资源模型 (`ResourceModel`)
- [x] UI视频模型 (`VideoItem`) 及其转换方法

**文件**: 
- `lib/models/api_response.dart`
- `lib/models/video_api_model.dart`
- `lib/models/video_item.dart`

#### 3.2 API 服务
- [x] 热门视频API服务类
- [x] 实现 `asyncGetHotVideoAPI()` - 初始加载
- [x] 实现 `getHotVideoAPI()` - 滚动加载更多
- [x] 错误处理和异常捕获
- [x] API 基础URL配置：`http://anime.ayypd.cn:3000`

**API 接口**:
```
GET /api/v1/video/getHotVideo?page=页码&pageSize=内容数量
```

**文件**: `lib/services/video_api_service.dart`

#### 3.3 分页加载功能
- [x] 初始加载：使用 `asyncGetHotVideoAPI` 加载第一页（10条）
- [x] 滚动加载：监听滚动位置，到达底部80%时自动加载下一页
- [x] 分页状态管理（当前页码、是否还有更多数据）
- [x] 加载状态指示器
- [x] 数据合并逻辑

**实现位置**: `lib/pages/home_page.dart`

#### 3.4 错误处理
- [x] 网络错误捕获和提示
- [x] API错误响应处理
- [x] 重试功能
- [x] 友好错误提示界面

---

### 4. 依赖管理

#### 4.1 已添加依赖
- [x] `http: ^1.2.0` - HTTP 网络请求库
- [x] `cupertino_icons: ^1.0.8` - iOS 风格图标
- [x] `flutter_lints: ^5.0.0` - 代码规范检查

**文件**: `pubspec.yaml`

---

## 技术实现细节

### 双列布局实现
- 使用 `SliverGrid` 实现响应式双列网格
- 宽高比设置为 `0.75`
- 列间距：8px，行间距：12px

### 数据格式转换
- API 返回的 `duration` 为秒数（double类型）
- 自动转换为 `mm:ss` 格式显示
- 播放次数和弹幕数量自动格式化（万、k等单位）

### 滚动加载触发机制
- 监听 `ScrollController` 的滚动位置
- 当滚动位置达到最大滚动距离的 80% 时触发加载
- 防止重复加载的保护机制

---

## 待开发功能 🚧

### 优先级 P0（高优先级）
- [ ] 视频详情页面
- [ ] 视频播放功能
- [ ] 用户登录/注册
- [ ] 个人中心完整功能

### 优先级 P1（中优先级）
- [ ] 视频搜索功能
- [ ] 视频分类/分区浏览
- [ ] 用户评论功能
- [ ] 点赞、收藏、分享功能

### 优先级 P2（低优先级）
- [ ] 用户关注系统
- [ ] 历史记录
- [ ] 播放列表
- [ ] 设置页面完善

---

## 已知问题

1. **弹幕数量字段缺失**: API 响应中暂无弹幕数量字段，当前显示为 0
   - 解决方案：等待后端添加弹幕数量字段，或使用其他API获取

---

## 代码质量

- ✅ 所有代码通过 Linter 检查
- ✅ 遵循 Flutter/Dart 代码规范
- ✅ 代码结构清晰，模块化设计
- ✅ 错误处理完善

---

## 测试状态

- [x] 基础UI渲染测试
- [ ] API 接口集成测试
- [ ] 分页加载功能测试
- [ ] 错误场景测试
- [ ] 性能测试

---

## 更新日志

### 2024-XX-XX
- ✅ 初始化项目结构
- ✅ 实现底部导航栏和基础页面
- ✅ 创建双列布局首页
- ✅ 完成热门视频API对接
- ✅ 实现分页加载功能

### 2025-01-18
#### 投稿功能 Token 刷新统一
- ✅ 统一使用 `TokenManager` 管理上传服务的 token
- ✅ 添加 `_postWithTokenRefresh()` 方法，支持 code=3000 时自动刷新重试
- ✅ 添加 `_multipartWithTokenRefresh()` 方法，支持文件上传的 token 刷新
- ✅ 所有上传 API（图片、视频分片、合并、获取信息）均已适配

**修改文件**: `lib/services/upload_api_service.dart`

#### 评论区表情包功能修复
- ✅ 修复 `emoji_picker_flutter` 3.x 版本 API 兼容问题
- ✅ 使用新的 `EmojiViewConfig`、`CategoryViewConfig`、`SearchViewConfig` 配置
- ✅ 添加深色/浅色主题适配
- ✅ "暂无最近使用的表情" 提示改为中文

**修改文件**: `lib/pages/video/widgets/comment_list.dart`

#### 评论回复功能增强
- ✅ 回复二级评论时自动添加 `@用户名` 前缀
- ✅ 发送评论成功后自动关闭表情选择面板
- ✅ 发送评论成功后触发刷新回调

**修改文件**: `lib/pages/video/widgets/comment_list.dart`

#### 评论预览卡片深色适配
- ✅ 使用 `context.colors` 主题扩展统一管理颜色
- ✅ 修复深色模式下头像、文字、背景等颜色显示问题

**修改文件**: `lib/pages/video/widgets/comment_preview_card.dart`

#### 自动连播功能修复
- ✅ 修复合集（分P）自动连播不生效的问题
- ✅ 修复推荐列表自动连播不生效的问题
- ✅ 将 `PartListState` 和 `RecommendListState` 设为公开类
- ✅ 在 `video_play_page.dart` 中添加 GlobalKey 访问子组件状态
- ✅ 视频播放结束时优先检查合集下一集，其次检查推荐列表

**修改文件**:
- `lib/pages/video/video_play_page.dart`
- `lib/pages/video/widgets/part_list.dart`
- `lib/pages/video/widgets/recommend_list.dart`

---

## 开发规范

### 代码风格
- 使用 Dart 官方代码规范
- 文件名使用下划线命名（snake_case）
- 类名使用大驼峰命名（PascalCase）
- 变量和方法使用小驼峰命名（camelCase）

### 提交规范
- feat: 新功能
- fix: 修复bug
- docs: 文档更新
- style: 代码格式调整
- refactor: 代码重构
- test: 测试相关
- chore: 构建/工具相关

---

## 联系方式

如有问题或建议，请联系开发团队。

---

**最后更新**: 2025-01-18
**文档版本**: v1.1.0
