# å°é¢å›¾ç‰‡æ˜¾ç¤ºä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

åº”ç”¨ä¸­è§†é¢‘å°é¢å›¾ç‰‡æ— æ³•æ˜¾ç¤ºã€‚

## é—®é¢˜åˆ†æ

### 1. APIè¿”å›çš„æ•°æ®æ ¼å¼

APIè¿”å›çš„å°é¢URLæ˜¯**ç›¸å¯¹è·¯å¾„**ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
```json
{
  "cover": "/api/image/1887881468064043008.png",
  "author": {
    "avatar": "/api/image/1984551037033254912.png"
  }
}
```

### 2. å®é™…å›¾ç‰‡è®¿é—®æ–¹å¼

é€šè¿‡æµ‹è¯•å‘ç°ï¼Œåç«¯å›¾ç‰‡æœåŠ¡çš„è®¿é—®è§„åˆ™ï¼š

âœ… **æ­£ç¡®çš„è®¿é—®æ–¹å¼**ï¼š
```
http://anime.ayypd.cn:3000/api/image/1887881468064043008.png
â†’ è¿”å› 301 é‡å®šå‘åˆ° OSS
â†’ æœ€ç»ˆé‡å®šå‘åˆ°: http://oss.ayypd.cn:9002/video/image/1887881468064043008.png?ç­¾åå‚æ•°
```

**å…³é”®å‘ç°**ï¼š
- åç«¯å›¾ç‰‡æœåŠ¡**éœ€è¦ä¿ç•™æ–‡ä»¶æ‰©å±•å**ï¼ˆ.pngã€.jpgç­‰ï¼‰
- è®¿é—®æ—¶ä¼šè‡ªåŠ¨é‡å®šå‘åˆ°å®é™…çš„OSSå­˜å‚¨åœ°å€
- Flutterçš„`Image.network`ç»„ä»¶ä¼šè‡ªåŠ¨è·ŸéšHTTPé‡å®šå‘

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶ï¼š[lib/models/video_item.dart](../lib/models/video_item.dart)

åœ¨`VideoItem.fromApiModel`æ–¹æ³•ä¸­æ·»åŠ äº†ç®€å•çš„`getFullImageUrl`å‡½æ•°æ¥å¤„ç†å›¾ç‰‡URLï¼š

```dart
// æ‹¼æ¥å®Œæ•´çš„å›¾ç‰‡URL
String getFullImageUrl(String path) {
  if (path.isEmpty) return '';
  if (path.startsWith('http://') || path.startsWith('https://')) {
    return path; // å·²ç»æ˜¯å®Œæ•´URL
  }
  // APIè¿”å›çš„æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦æ‹¼æ¥baseUrl
  // ä¾‹å¦‚: "/api/image/1887881468064043008.png"
  return '${VideoApiService.baseUrl}$path';
}
```

### å¤„ç†é€»è¾‘

1. **æ£€æŸ¥æ˜¯å¦ä¸ºç©ºè·¯å¾„**ï¼šå¦‚æœä¸ºç©ºï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
2. **æ£€æŸ¥æ˜¯å¦ä¸ºå®Œæ•´URL**ï¼šå¦‚æœå·²åŒ…å«http://æˆ–https://ï¼Œç›´æ¥è¿”å›
3. **æ‹¼æ¥baseUrl**ï¼šå°†ç›¸å¯¹è·¯å¾„ä¸baseUrlç›´æ¥æ‹¼æ¥æˆå®Œæ•´URLï¼ˆ**ä¿ç•™åŸå§‹æ‰©å±•å**ï¼‰

### URLè½¬æ¢ç¤ºä¾‹

```
è¾“å…¥: "/api/image/1887881468064043008.png"
â†“ æ‹¼æ¥baseUrlï¼ˆä¿ç•™æ‰©å±•åï¼‰
è¾“å‡º: "http://anime.ayypd.cn:3000/api/image/1887881468064043008.png"
```

## æµ‹è¯•éªŒè¯

### æ—¥å¿—è¾“å‡º

```
ğŸ“¸ ç¬¬ä¸€ä¸ªè§†é¢‘å°é¢: /api/image/1887881468064043008.png
ğŸ–¼ï¸ è½¬æ¢åçš„å°é¢URL: http://anime.ayypd.cn:3000/api/image/1887881468064043008.png
```

### æµ‹è¯•ç»“æœ

âœ… **Chrome Webå¹³å°**ï¼šå°é¢å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º
- URLè½¬æ¢æ­£ç¡®
- å›¾ç‰‡æˆåŠŸåŠ è½½
- æ— 404æˆ–403é”™è¯¯

## æ¶‰åŠçš„æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶

1. **[lib/models/video_item.dart](../lib/models/video_item.dart)**
   - æ·»åŠ äº†`import '../services/video_api_service.dart'`
   - å®ç°äº†`getFullImageUrl`å‡½æ•°
   - ä¿®æ”¹äº†`coverUrl`å’Œ`authorAvatar`çš„èµ‹å€¼é€»è¾‘

### è°ƒè¯•æ—¥å¿—æ–‡ä»¶

2. **[lib/services/video_api_service.dart](../lib/services/video_api_service.dart)**
   - æ·»åŠ äº†å°é¢URLçš„è°ƒè¯•æ—¥å¿—

3. **[lib/pages/home_page.dart](../lib/pages/home_page.dart)**
   - æ·»åŠ äº†è½¬æ¢åURLçš„è°ƒè¯•æ—¥å¿—

## åç«¯å›¾ç‰‡æœåŠ¡è¯´æ˜

### é‡å®šå‘æœºåˆ¶

åç«¯å›¾ç‰‡æœåŠ¡ä½¿ç”¨äº†é‡å®šå‘æœºåˆ¶ï¼š

1. å®¢æˆ·ç«¯è¯·æ±‚ï¼š`GET http://anime.ayypd.cn:3000/api/image/1887881468064043008`
2. æœåŠ¡å™¨å“åº”ï¼š`301 Moved Permanently`
3. Locationå¤´ï¼š`http://oss.ayypd.cn:9002/video/image/1887881468064043008?ç­¾åå‚æ•°`
4. å®¢æˆ·ç«¯è‡ªåŠ¨è·Ÿéšé‡å®šå‘ï¼Œè·å–å®é™…å›¾ç‰‡

### å›¾ç‰‡URLè§„åˆ™

| æ ¼å¼ | æ˜¯å¦å¯ç”¨ | è¯´æ˜ |
|------|---------|------|
| `/api/image/ID.png` | âŒ | APIè¿”å›çš„ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦æ‹¼æ¥baseUrl |
| `http://baseUrl/api/image/ID.png` | âœ… | å®Œæ•´URLï¼ˆå¸¦æ‰©å±•åï¼‰ï¼Œä¼šé‡å®šå‘åˆ°OSS |

## åŒæ—¶ä¿®å¤çš„å†…å®¹

é™¤äº†è§†é¢‘å°é¢ï¼Œè¿˜åŒæ—¶ä¿®å¤äº†ï¼š
- âœ… ä½œè€…å¤´åƒURLå¤„ç†
- âœ… ç”¨æˆ·ç©ºé—´å°é¢URLå¤„ç†ï¼ˆé€šè¿‡ç›¸åŒçš„`getFullImageUrl`å‡½æ•°ï¼‰

## æœ€ä½³å®è·µ

### å›¾ç‰‡URLå¤„ç†å»ºè®®

1. **æ€»æ˜¯ä½¿ç”¨å®Œæ•´URL**ï¼šæ‹¼æ¥baseUrlï¼Œé¿å…ç›¸å¯¹è·¯å¾„é—®é¢˜
2. **éµå¾ªåç«¯è§„åˆ™**ï¼šæ ¹æ®å®é™…APIè¡Œä¸ºè°ƒæ•´URLæ ¼å¼
3. **å¤„ç†æ‰©å±•å**ï¼šæ ¹æ®åç«¯è¦æ±‚æ·»åŠ æˆ–ç§»é™¤æ‰©å±•å
4. **æ·»åŠ é”™è¯¯å¤„ç†**ï¼šä½¿ç”¨`errorBuilder`æ˜¾ç¤ºå ä½å›¾
5. **æ·»åŠ åŠ è½½çŠ¶æ€**ï¼šä½¿ç”¨`loadingBuilder`æ”¹å–„ç”¨æˆ·ä½“éªŒ

### ä»£ç ç¤ºä¾‹

```dart
Image.network(
  video.coverUrl,
  fit: BoxFit.cover,
  errorBuilder: (context, error, stackTrace) {
    return Container(
      color: Colors.grey[300],
      child: const Icon(Icons.broken_image),
    );
  },
  loadingBuilder: (context, child, loadingProgress) {
    if (loadingProgress == null) return child;
    return CircularProgressIndicator();
  },
)
```

## æ€»ç»“

### âœ… å·²ä¿®å¤
1. åˆ†æäº†APIè¿”å›çš„å›¾ç‰‡URLæ ¼å¼
2. å‘ç°åç«¯å›¾ç‰‡æœåŠ¡éœ€è¦æ— æ‰©å±•åçš„URL
3. å®ç°äº†URLè½¬æ¢å‡½æ•°
4. åŒæ—¶å¤„ç†äº†å°é¢å’Œå¤´åƒ
5. éªŒè¯ä¿®å¤æ•ˆæœ

### ğŸ“ å…³é”®è¦ç‚¹
- APIè¿”å›çš„æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦æ‹¼æ¥baseUrl
- å¿…é¡»**ä¿ç•™æ–‡ä»¶æ‰©å±•å**ï¼ˆ.png, .jpgç­‰ï¼‰
- åç«¯ä½¿ç”¨é‡å®šå‘åˆ°OSSçš„æ–¹å¼æä¾›å›¾ç‰‡
- Flutterçš„Image.networkè‡ªåŠ¨å¤„ç†é‡å®šå‘

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-02
**æµ‹è¯•å¹³å°**: Chrome (é€šè¿‡)
**ä¿®å¤çŠ¶æ€**: âœ… å·²éªŒè¯æ­£å¸¸
